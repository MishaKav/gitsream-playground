# Code generated by gitStream GitHub app - DO NOT EDIT

name: gitStream workflow automation
run-name: |
  /:\ gitStream: PR #${{ fromJSON(fromJSON(github.event.inputs.client_payload)).pullRequestNumber }}

on:
  workflow_dispatch:
    inputs:
      client_payload:
        description: The Client payload
        required: true
      full_repository:
        description: the repository name include the owner in `owner/repo_name` format
        required: true
      head_ref:
        description: the head sha
        required: true
      base_ref:
        description: the base ref
        required: true
      installation_id:
        description: the installation id
        required: false
      resolver_url:
        description: the resolver url to pass results to
        required: true
      resolver_token:
        description: Optional resolver token for resolver service
        required: false
        default: ''
      debug_mode:
        description: 'Run parser in debug mode'
        type: boolean
        required: false
        default: true

jobs:
  gitStream:
    timeout-minutes: 5
    runs-on: ubuntu-latest
    name: gitStream workflow automation
    steps:
      - name: Create GitStream folder
        id: create-gitstream-folder
        shell: bash
        run: |
          rm -rf gitstream
          mkdir gitstream
          cd gitstream
          mkdir repo

      - name: Checkout base branch
        uses: actions/checkout@v3
        with:
          repository: ${{ github.event.inputs.full_repository }}
          ref: ${{ github.event.inputs.base_ref }}
          path: 'gitstream/repo/'
          token: ${{ fromJSON(fromJSON(github.event.inputs.client_payload)).githubToken || github.token }}

      - name: Escape single quotes
        id: safe-strings
        uses: actions/github-script@v7
        env:
          BASE_REF_ARG: ${{ github.event.inputs.base_ref }}
          HEAD_REF_ARG: ${{ github.event.inputs.head_ref }}
          PAYLOAD_ARG: ${{ github.event.inputs.client_payload }}
          URL_ARG: ${{ fromJSON(fromJSON(github.event.inputs.client_payload)).headHttpUrl || fromJSON(fromJSON(github.event.inputs.client_payload)).repoUrl }}
        with:
          script: |
            try {
              function convertToSafeString(input) {
                return (input || '').replace(/['`]/g, "\\$&");
              };
              function escapeApostrophe(input) {
                return (input || '').replace(/'/g, "\\'");
              };
              const base_ref = escapeApostrophe(process.env.BASE_REF_ARG);
              const head_ref = escapeApostrophe(process.env.HEAD_REF_ARG);
              const url = convertToSafeString(process.env.URL_ARG);
              const client_payload = convertToSafeString(process.env.PAYLOAD_ARG);
              core.setOutput('base_ref', base_ref);
              core.setOutput('head_ref', head_ref);
              core.setOutput('url', url);
              core.setOutput('client_payload', client_payload);
            } catch (err) {
              core.error(`Failed producing safe string: ${err}`);
              process.exit(1);
            }

      - name: Checkout Pull Request branches history
        run: |
          all=2147483647
          cd gitstream
          cd repo
          git fetch --deepen=$all origin $'${{ steps.safe-strings.outputs.base_ref }}'
          git remote add upstream $'${{ steps.safe-strings.outputs.url }}'
          git fetch --deepen=$all upstream $'${{ steps.safe-strings.outputs.head_ref }}'
          git checkout -b $'upstream/${{ steps.safe-strings.outputs.head_ref}}' $'upstream/${{ steps.safe-strings.outputs.head_ref}}'
        shell: bash

      - name: Create cm folder
        id: create-cm-folder
        shell: bash
        run: |
          cd gitstream
          mkdir cm

      - name: Checkout cm repo
        uses: actions/checkout@v3
        # if: ${{ fromJSON(fromJSON(github.event.inputs.client_payload)).hasCmRepo == true }}
        with:
          repository: '${{ fromJSON(fromJSON(github.event.inputs.client_payload)).owner }}/gitsream-playground'
          ref: ${{ fromJSON(fromJSON(github.event.inputs.client_payload)).cmRepoRef }}
        #   path: 'gitstream/cm/'

      - name: os setup
        run: |
          sudo apt update -y
          sudo apt install curl
          touch $NPMRC
          curl -H "X-JFrog-Art-API: $ARTIFACTORY_API_KEY" https://linearb.jfrog.io/linearb/api/npm/npm-local/auth/linearb >> $NPMRC
        env:
          NPMRC: '.npmrc'
          ARTIFACTORY_API_KEY: ${{ secrets.ARTIFACTORY_API_KEY }}

      - name: Run Action
        run: npm ci

      - name: Run RulesEngine
        uses: actions/github-script@v7
        env:
          HEAD_REF: 'upstream/${{ steps.safe-strings.outputs.head_ref }}'
          BASE_REF: '${{ steps.safe-strings.outputs.base_ref }}'
          CLIENT_PAYLOAD: ${{ steps.safe-strings.outputs.client_payload }}
          RULES_RESOLVER_URL: ${{ github.event.inputs.resolver_url }}
          RULES_RESOLVER_TOKEN: ${{ github.event.inputs.resolver_token }}
          DEBUG_MODE: false
        with:
          script: |
            const { RulesEngine } = require("@linearb/gitstream-core");
            try {
              console.log("Running gitstream-rules-engine v.misha");
              const rulesEngine = new RulesEngine();
              await rulesEngine.run();
            } catch (err) {
              core.error(`Failed run RulesEngine: ${err}`);
              process.exit(1);
            }

      # - name: Run The Action
      #   id: gitstream-action
      #   if: always()
      #   run: |
      #     env_file=env.user
      #     touch $env_file
      #     for var in $(env | cut -d "=" -f 1); do
      #       value="${!var}"
      #       echo "$var=$value" >> "$env_file"
      #     done
      #     docker pull gitstream/rules-engine:latest
      #     docker run --env-file $env_file -v $(pwd)/gitstream:/code -e HEAD_REF=$'upstream/${{ steps.safe-strings.outputs.head_ref }}' -e BASE_REF=$'${{ steps.safe-strings.outputs.base_ref }}' -e CLIENT_PAYLOAD=${{ steps.safe-strings.outputs.client_payload }} -e RULES_RESOLVER_URL=${{ github.event.inputs.resolver_url }} -e RULES_RESOLVER_TOKEN=${{ github.event.inputs.resolver_token }} -e DEBUG_MODE=${{ github.event.inputs.debug_mode }} gitstream/rules-engine
      #   shell: bash

      # - name: Evaluate Rules
      #   uses: linear-b/gitstream-github-action@v1
      #   id: rules-engine
      #   with:
      #     full_repository: ${{ github.event.inputs.full_repository }}
      #     head_ref: ${{ github.event.inputs.head_ref }}
      #     base_ref: ${{ github.event.inputs.base_ref }}
      #     client_payload: ${{ github.event.inputs.client_payload }}
      #     installation_id: ${{ github.event.inputs.installation_id }}
      #     resolver_url: ${{ github.event.inputs.resolver_url }}
      #     resolver_token: ${{ github.event.inputs.resolver_token }}
      #     debug_mode: true
